name: Scan DB update

on:
  workflow_dispatch:
  schedule:
    - cron: '27 5 * * 5'

jobs:
  Scan-DB-Update:
    permissions:
      contents: write
      pull-requests: write
      
    runs-on: ubuntu-latest
    name: Scan DB update
    steps:
    - name: Cache OpenAF runtime
      uses: actions/cache@v3
      with:
        key : oaf-t8
        path: /tmp/oaf

    - name: Files cleanup
      run : |
        docker volume rm trivy-db 2>/dev/null || true

    - name: Retrieve trivy java database
      uses: openaf/ojob-action@v5
      with:
        ojob: 'ojob.io/sec/trivy'
        args: 'dockerOptions="-v trivy-db:/root/.cache/trivy" options="image --download-java-db-only"'
      
    - name: Retrieve trivy database
      uses: openaf/ojob-action@v5
      with:
        ojob: 'ojob.io/sec/trivy'
        args: 'dockerOptions="-v trivy-db:/root/.cache/trivy" options="image --download-db-only"'

    - name: Store the trivy databases in cache
      run : |
        rm -rf /tmp/trivy-db
        mkdir -p /tmp/trivy-db
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar czf /backup/trivy-db.tgz -C /volume .

    - name: Save cache
      uses: actions/cache@v4
      with:
        key : trivy-db
        path: /tmp/trivy-db