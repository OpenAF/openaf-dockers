name: Scan Images

on:
  workflow_dispatch:
  schedule:
    - cron: '00 7 * * *'

jobs:
  setup:
    runs-on: ubuntu-latest
    name: Setup
    steps:
    - name: Cache OpenAF runtime
      uses: actions/cache@v4
      with:
        key : oaf-t8
        path: /tmp/oaf

    - name: Cache and restore trivy databases
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db
        
    - name: Download trivy databases if not cached or older than 12 hours
      run: |
        mkdir -p /tmp/trivy-db
        RELOAD=false
        
        # Check if file exists and is older than 12 hours
        if [ -f /tmp/trivy-db/trivy-db.tgz ]; then
          FILE_AGE=$(($(date +%s) - $(stat -f %m /tmp/trivy-db/trivy-db.tgz 2>/dev/null || stat -c %Y /tmp/trivy-db/trivy-db.tgz)))
          if [ $FILE_AGE -gt 43200 ]; then
            echo "Trivy database is older than 12 hours (${FILE_AGE}s old), reloading..."
            RELOAD=true
          else
            echo "Trivy database is recent (${FILE_AGE}s old), skipping download"
          fi
        else
          echo "Trivy database not found, downloading..."
          RELOAD=true
        fi
        
        if [ "$RELOAD" = true ]; then
          wget -O /tmp/trivy-db/trivy-db.tgz https://openaf.io/trivy-db.tgz
        fi

  scan-oaf-latest:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:latest
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan latest
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:latest file=.github/sec-latest.svg reportFile=.github/sec-latest.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-latest.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-latest.yaml file=.github/sec-latest.md'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-latest
        path: |
          .github/sec-latest.svg
          .github/sec-latest.yaml
          .github/sec-latest.md

  scan-oaf-nightly:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:nightly
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan nightly
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:nightly file=.github/sec-nightly.svg reportFile=.github/sec-nightly.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-nightly.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-nightly.yaml file=.github/sec-nightly.md'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-nightly
        path: |
          .github/sec-nightly.svg
          .github/sec-nightly.yaml
          .github/sec-nightly.md

  scan-oaf-edge:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:edge
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan edge
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:edge file=.github/sec-edge.svg reportFile=.github/sec-edge.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-edge.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-edge.yaml file=.github/sec-edge.md'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-edge
        path: |
          .github/sec-edge.svg
          .github/sec-edge.yaml
          .github/sec-edge.md

  scan-oaf-ubi-nightly:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:ubi-nightly
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan UBI nightly
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:ubi-nightly file=.github/sec-ubi-nightly.svg reportFile=.github/sec-ubi-nightly.yaml'
        dist: 't8'

    - uses: openaf/ojob-action@v7
      name: Generate sec-ubi-nightly.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-ubi-nightly.yaml file=.github/sec-ubi-nightly.md'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-ubi-nightly
        path: |
          .github/sec-ubi-nightly.svg
          .github/sec-ubi-nightly.yaml
          .github/sec-ubi-nightly.md

  scan-oaf-deb-nightly:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:deb-nightly
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan DEB nightly
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:deb-nightly file=.github/sec-deb-nightly.svg reportFile=.github/sec-deb-nightly.yaml'
        dist: 't8'
    
    - uses: openaf/ojob-action@v7
      name: Generate sec-deb-nightly.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-deb-nightly.yaml file=.github/sec-deb-nightly.md'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-deb-nightly
        path: |
          .github/sec-deb-nightly.svg
          .github/sec-deb-nightly.yaml
          .github/sec-deb-nightly.md

  scan-oaf-ubi-latest:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:ubi
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan UBI latest
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:ubi file=.github/sec-ubi-latest.svg reportFile=.github/sec-ubi-latest.yaml'
        dist: 't8'

    - uses: openaf/ojob-action@v7
      name: Generate sec-ubi-latest.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-ubi-latest.yaml file=.github/sec-ubi-latest.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-ubi-latest
        path: |
          .github/sec-ubi-latest.svg
          .github/sec-ubi-latest.yaml
          .github/sec-ubi-latest.md

  scan-oaf-deb-latest:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/oaf:deb
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan DEB latest
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/oaf:deb file=.github/sec-deb-latest.svg reportFile=.github/sec-deb-latest.yaml'
        dist: 't8'        

    - uses: openaf/ojob-action@v7
      name: Generate sec-deb-latest.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-deb-latest.yaml file=.github/sec-deb-latest.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-deb-latest
        path: |
          .github/sec-deb-latest.svg
          .github/sec-deb-latest.yaml
          .github/sec-deb-latest.md

  scan-ojobrt-latest:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/ojobrt:latest
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan oJobRT latest
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/ojobrt:latest file=.github/sec-oJobRT-latest.svg reportFile=.github/sec-oJobRT-latest.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-oJobRT-latest.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-oJobRT-latest.yaml file=.github/sec-oJobRT-latest.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-ojobrt-latest
        path: |
          .github/sec-oJobRT-latest.svg
          .github/sec-oJobRT-latest.yaml
          .github/sec-oJobRT-latest.md

  scan-ojobrt-nightly:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/ojobrt:nightly
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume
        
    - uses: openaf/ojob-action@v7
      name: Scan oJobRT nightly
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/ojobrt:nightly file=.github/sec-oJobRT-nightly.svg reportFile=.github/sec-oJobRT-nightly.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-oJobRT-nightly.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-oJobRT-nightly.yaml file=.github/sec-oJobRT-nightly.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-ojobrt-nightly
        path: |
          .github/sec-oJobRT-nightly.svg
          .github/sec-oJobRT-nightly.yaml
          .github/sec-oJobRT-nightly.md

  scan-pyoaf-nightly:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/pyoaf:nightly
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan pyOAF nightly
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/pyoaf:nightly file=.github/sec-pyOAF-nightly.svg reportFile=.github/sec-pyOAF-nightly.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-pyOAF-nightly.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-pyOAF-nightly.yaml file=.github/sec-pyOAF-nightly.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-pyoaf-nightly
        path: |
          .github/sec-pyOAF-nightly.svg
          .github/sec-pyOAF-nightly.yaml
          .github/sec-pyOAF-nightly.md

  scan-ojobrt-edge:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/ojobrt:edge
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan oJobRT edge
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/ojobrt:edge file=.github/sec-oJobRT-edge.svg reportFile=.github/sec-oJobRT-edge.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-oJobRT-edge.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-oJobRT-edge.yaml file=.github/sec-oJobRT-edge.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-ojobrt-edge
        path: |
          .github/sec-oJobRT-edge.svg
          .github/sec-oJobRT-edge.yaml
          .github/sec-oJobRT-edge.md

  scan-pyoaf-edge:
    needs: setup
    runs-on: ubuntu-latest
    name: Scan openaf/pyoaf:edge
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - name: Restore the trivy databases from cache
      uses: actions/cache@v4
      with:
        key: trivy-db-${{ runner.os }}
        path: /tmp/trivy-db

    - name: Load trivy databases into Docker
      run: |
        docker run --rm -v trivy-db:/volume -v /tmp/trivy-db:/backup busybox tar xzf /backup/trivy-db.tgz -C /volume

    - uses: openaf/ojob-action@v7
      name: Scan pyOAF edge
      with:
        ojob: 'ojob.io/sec/genSecBadge'
        args: 'image=openaf/pyoaf:edge file=.github/sec-pyOAF-edge.svg reportFile=.github/sec-pyOAF-edge.yaml'
        dist: 't8'
        
    - uses: openaf/ojob-action@v7
      name: Generate sec-pyOAF-edge.md
      with:
        ojob: 'ojob.io/util/toMDTree'
        args: 'inputFile=.github/sec-pyOAF-edge.yaml file=.github/sec-pyOAF-edge.md'
        dist: 't8'

    - uses: actions/upload-artifact@v4
      with:
        name: sec-pyoaf-edge
        path: |
          .github/sec-pyOAF-edge.svg
          .github/sec-pyOAF-edge.yaml
          .github/sec-pyOAF-edge.md

  push:
    permissions:
      contents: write
      pull-requests: write
    needs: [scan-oaf-latest, scan-oaf-nightly, scan-oaf-edge, scan-oaf-ubi-nightly, scan-oaf-deb-nightly, scan-oaf-ubi-latest, scan-oaf-deb-latest, scan-ojobrt-latest, scan-ojobrt-nightly, scan-pyoaf-nightly, scan-ojobrt-edge, scan-pyoaf-edge]
    runs-on: ubuntu-latest
    name: Push results
    steps:
    - uses: actions/checkout@v4
      name: Checkout

    - uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Copy artifacts to .github directory
      run: |
        find artifacts -type f -exec cp {} .github/ \;
        ls -la .github/*.svg .github/*.yaml .github/*.md 2>/dev/null | head -20

    - uses: openaf/ojob-action@v7
      name: Push
      env :
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        ojob: 'ojob.io/git/hub/contentIn'
        args: 'message="update\ badge\ {{date}}/{{time}}" title="Update\ badges" paths=.github/'
        dist: t8
